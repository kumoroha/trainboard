<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>列車発車標</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 20px;
            background-color: #f0f0f0;
        }
        .departure-board {
            background-color: #000;
            color: #fff;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.3);
        }
        .board-title {
            font-size: 1.5em;
            text-align: center;
            margin-bottom: 15px;
        }
        .departure-item {
            display: grid;
            grid-template-columns: 0.8fr 1fr 0.8fr 1fr 1fr 1fr; /* カラム数を調整 */
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #333;
        }
        .departure-item:last-child {
            border-bottom: none;
        }
        .departure-item span {
            text-align: left;
        }
        .departure-item .time {
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="departure-board">
        <div class="board-title">列車発車標</div>
        <div id="departures">
            </div>
    </div>

    <script>
const departuresDiv = document.getElementById('departures');
        let departures = [];

        function displayDepartures() {
            departuresDiv.innerHTML = '';
            const now = new Date();
            const nowMinutes = now.getHours() * 60 + now.getMinutes();
            let hasUpcomingDeparture = false;

            departures.forEach(departure => {
                console.log("displayDepartures内のdeparture:", departure); // ★ 追加
                console.log("departure.time:", departure ? departure.time : 'departureはundefined'); // ★ 追加
                if (departure && typeof departure.time === 'string') { // ★ 安全な呼び出し
                    const departureTimeParts = departure.time.split(':');
                    const departureMinutes = parseInt(departureTimeParts[0]) * 60 + parseInt(departureTimeParts[1]);
                    let remainingMinutes = departureMinutes - nowMinutes;

                    let remainingTimeText = '';
                    if (remainingMinutes > 0) {
                        remainingTimeText = `あと ${remainingMinutes} 分`;
                        hasUpcomingDeparture = true;
                    } else if (remainingMinutes === 0) {
                        remainingTimeText = 'まもなく発車';
                        hasUpcomingDeparture = true;
                    } else {
                        remainingTimeText = '発車済';
                    }

                    const item = document.createElement('div');
                    item.classList.add('departure-item');
                    item.innerHTML = `
                        <span class="time">${departure.time}</span>
                        <span class="platform">${departure.platform}番線</span>
                        <span class="trainName">${departure.trainName}</span>
                        <span class="destination">${departure.destination}</span>
                        <span class="remarks">${departure.remarks}</span>
                        <span>${remainingTimeText}</span>
                    `;
                    departuresDiv.appendChild(item);
                } else {
                    console.warn("時刻データが無効なため、この列車は表示しません:", departure); // ★ 警告表示
                    // または、何らかの代替表示を行う
                    const item = document.createElement('div');
                    item.classList.add('departure-item');
                    item.innerHTML = `
                        <span class="time">--:--</span>
                        <span class="platform">--</span>
                        <span class="trainName">--</span>
                        <span class="destination">--</span>
                        <span class="remarks">時刻データなし</span>
                        <span>--</span>
                    `;
                    departuresDiv.appendChild(item);
                }
            });

            if (!hasUpcomingDeparture && departures.length > 0) {
                const messageDiv = document.createElement('div');
                messageDiv.textContent = '今日の列車はもうありません。';
                messageDiv.style.padding = '10px';
                messageDiv.style.textAlign = 'center';
                departuresDiv.appendChild(messageDiv);
            } else if (departures.length === 0 && departuresDiv.textContent === '発車情報の取得に失敗しました。') {
                // APIエラーメッセージが表示されている場合はそのままにする
            } else if (departures.length === 0) {
                const messageDiv = document.createElement('div');
                messageDiv.textContent = '発車情報はありません。';
                messageDiv.style.padding = '10px';
                messageDiv.style.textAlign = 'center';
                departuresDiv.appendChild(messageDiv);
            }
        }

        function fetchDepartureData() {
            const apiUrl = 'https://kumoroha.github.io/trainboard/departures.json';

            fetch(apiUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("APIからのデータ:", data); // ★ 追加
                    departures = data.map(item => {
                        console.log("map内のitem:", item); // ★ 追加
                        return {
                            time: item.departureTime,
                            destination: item.destinationName,
                            platform: item.platformNumber,
                            trainName: item.trainDisplayName,
                            remarks: item.delayInformation || '',
                        };
                    });
                    console.log("加工後のdepartures:", departures); // ★ 追加
                    displayDepartures();
                })
                .catch(error => {
                    console.error('APIからのデータ取得エラー:', error);
                    departuresDiv.textContent = '発車情報の取得に失敗しました。';
                });
        }

        // ページ読み込み時にAPIからデータを取得
        fetchDepartureData();

        // (必要に応じて定期的にAPIを呼び出すように設定)
        // setInterval(fetchDepartureData, 30000);
    </script>
</body>
</html>
