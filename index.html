<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>列車発車標</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 20px;
            background-color: #f0f0f0;
        }
        .departure-board {
            background-color: #000;
            color: #fff;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.3);
        }
        .board-title {
            font-size: 1.5em;
            text-align: center;
            margin-bottom: 10px;
        }
        .board-header {
            display: grid;
            grid-template-columns: minmax(50px, 0.8fr) minmax(40px, 0.5fr) minmax(60px, 0.8fr) minmax(100px, 1fr) minmax(100px, 1fr) minmax(70px, 1fr) minmax(70px, 1fr);
            gap: 10px;
            padding: 8px 0;
            border-bottom: 2px solid #fff;
            margin-bottom: 5px;
        }
        .board-header span {
            text-align: left;
            font-weight: bold;
            display: inline-block;
        }
        .departure-list {
            overflow: hidden;
        }
        .departure-item {
            display: grid;
            grid-template-columns: minmax(50px, 0.8fr) minmax(40px, 0.5fr) minmax(60px, 0.8fr) minmax(100px, 1fr) minmax(100px, 1fr) minmax(70px, 1fr) minmax(70px, 1fr);
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #333;
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
        }
        .departure-item.departed {
            opacity: 0;
            transform: translateY(-100%);
        }
        .departure-item:last-child {
            border-bottom: none;
        }
        .departure-item span {
            text-align: left;
            display: inline-block;
        }
        .departure-item .time {
            font-weight: bold;
        }
        .train-type-普通 {
            color: white;
        }
        .train-type-快速 {
            color: orange;
        }
        .train-type-新快速 {
            color: blue;
        }
        .train-type-特急 {
            color: red;
        }

        div > input[type="radio"] {
            margin-right: 5px;
        }

        div > label {
            margin-right: 15px;
        }

        div > input[type="time"] {
            margin-left: 10px;
        }

        div > button {
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <div>
        <input type="radio" id="realtime" name="displayMode" value="realtime" checked>
        <label for="realtime">リアルタイム</label>

        <input type="radio" id="specifiedTime" name="displayMode" value="specifiedTime">
        <label for="specifiedTime">時間指定</label>

        <input type="time" id="specifiedTimeInput" disabled>
        <button id="applyTime">適用</button>
    </div>

    <div class="departure-board">
        <div class="board-title">列車発車標</div>
        <div class="board-header">
            <span style="grid-column: 1;">時刻</span>
            <span style="grid-column: 2;">種別</span>
            <span style="grid-column: 3;">番線</span>
            <span style="grid-column: 4;">列車名</span>
            <span style="grid-column: 5;">行き先</span>
            <span style="grid-column: 6;">備考</span>
            <span style="grid-column: 7;">発車まで</span>
        </div>
        <div id="departures" class="departure-list">
            </div>
    </div>

    <script>
        const departuresDiv = document.getElementById('departures');
        const realtimeRadio = document.getElementById('realtime');
        const specifiedTimeRadio = document.getElementById('specifiedTime');
        const specifiedTimeInput = document.getElementById('specifiedTimeInput');
        const applyTimeButton = document.getElementById('applyTime');
        let allDepartures = [];
        let displayedDepartures = [];
        const maxDisplayCount = 4;
        let noUpcomingTrainsMessageShown = false;
        let displayMode = 'realtime';
        let specified時刻 = null;

        function displayDepartures(referenceTime) {
            departuresDiv.innerHTML = '';
            let nowMinutes;
            let nowForCalculation = new Date();

            if (displayMode === 'realtime') {
                nowMinutes = nowForCalculation.getHours() * 60 + nowForCalculation.getMinutes();
            } else if (displayMode === 'specifiedTime' && referenceTime) {
                const timeParts = referenceTime.split(':');
                nowMinutes = parseInt(timeParts[0]) * 60 + parseInt(timeParts[1]);
                nowForCalculation.setHours(parseInt(timeParts[0]));
                nowForCalculation.setMinutes(parseInt(timeParts[1]));
                nowForCalculation.setSeconds(0);
                nowForCalculation.setMilliseconds(0);
            } else {
                nowMinutes = nowForCalculation.getHours() * 60 + nowForCalculation.getMinutes();
            }

            const upcomingDepartures = allDepartures.filter(departure => {
                const departureTimeParts = departure.time.split(':');
                const departureMinutes = parseInt(departureTimeParts[0]) * 60 + parseInt(departureTimeParts[1]);
                return departureMinutes >= nowMinutes;
            }).sort((a, b) => {
                const timeA = a.time.replace(':', '');
                const timeB = b.time.replace(':', '');
                return parseInt(timeA) - parseInt(timeB);
            });

            displayedDepartures = upcomingDepartures.slice(0, maxDisplayCount);

            if (displayedDepartures.length === 0 && allDepartures.length > 0 && !noUpcomingTrainsMessageShown) {
                const messageDiv = document.createElement('div');
                messageDiv.textContent = '指定された時間以降の電車はありません。';
                messageDiv.style.padding = '10px';
                messageDiv.style.textAlign = 'center';
                departuresDiv.appendChild(messageDiv);
                noUpcomingTrainsMessageShown = true;
            } else if (displayedDepartures.length === 0 && allDepartures.length === 0 && departuresDiv.textContent !== '発車情報の取得に失敗しました。') {
                const messageDiv = document.createElement('div');
                messageDiv.textContent = '発車情報はありません。';
                messageDiv.style.padding = '10px';
                messageDiv.style.textAlign = 'center';
                departuresDiv.appendChild(messageDiv);
            } else {
                displayedDepartures.forEach(departure => {
                    const item = document.createElement('div');
                    item.classList.add('departure-item');

                    const departureTimeParts = departure.time.split(':');
                    const departureMinutes = parseInt(departureTimeParts[0]) * 60 + parseInt(departureTimeParts[1]);
                    let remainingMinutes;
                    let remainingTimeText = '';

                    const departureDate = new Date(nowForCalculation);
                    departureDate.setHours(parseInt(departureTimeParts[0]));
                    departureDate.setMinutes(parseInt(departureTimeParts[1]));
                    departureDate.setSeconds(0);
                    departureDate.setMilliseconds(0);

                    const diffMilliseconds = departureDate.getTime() - nowForCalculation.getTime();
                    remainingMinutes = Math.ceil(diffMilliseconds / (1000 * 60));

                    if (remainingMinutes > 0) {
                        remainingTimeText = `あと ${remainingMinutes} 分`;
                    } else if (remainingMinutes === 0) {
                        remainingTimeText = 'まもなく発車';
                    } else {
                        remainingTimeText = '発車済';
                    }

                    const trainTypeClass = `train-type-${departure.trainName.replace(/\s+/g, '')}`;

                    item.innerHTML = `
                        <span class="time">${departure.time}</span>
                        <span class="${trainTypeClass}">${departure.trainName}</span>
                        <span class="platform">${departure.platform}番線</span>
                        <span class="trainName" style="display:none;">${departure.trainName}</span>
                        <span class="destination">${departure.destination}</span>
                        <span class="remarks">${remainingTimeText}</span>
                        <span>${departure.remarks}</span>
                    `;
                    departuresDiv.appendChild(item);
                });

                if (displayMode === 'realtime' && displayedDepartures.length > 0 && displayedDepartures[0].time) {
                    const firstDepartureTimeParts = displayedDepartures[0].time.split(':');
                    const firstDepartureMinutes = parseInt(firstDepartureTimeParts[0]) * 60 + parseInt(firstDepartureTimeParts[1]);
                    const currentNow = new Date();
                    const currentNowMinutes = currentNow.getHours() * 60 + currentNow.getMinutes();

                    if (firstDepartureMinutes < currentNowMinutes) {
                        const departedItem = departuresDiv.firstChild;
                        if (departedItem) {
                            departedItem.classList.add('departed');
                            setTimeout(() => {
                                departuresDiv.removeChild(departedItem);
                                displayedDepartures.shift();
                                if (upcomingDepartures.length > displayedDepartures.length) {
                                    const nextDeparture = upcomingDepartures[displayedDepartures.length];
                                    const newItem = document.createElement('div');
                                    newItem.classList.add('departure-item');
                                    const nextDepartureTimeParts = nextDeparture.time.split(':');
                                    const nextDepartureMinutes = parseInt(nextDepartureTimeParts[0]) * 60 + parseInt(nextDepartureTimeParts[1]);
                                    let nextRemainingMinutes = nextDepartureMinutes - currentNowMinutes;
                                    let nextRemainingTimeText = '';
                                    if (nextRemainingMinutes > 0) {
                                        nextRemainingTimeText = `あと ${nextRemainingMinutes} 分`;
                                    } else if (nextRemainingMinutes === 0) {
                                        nextRemainingTimeText = 'まもなく発車';
                                    } else {
                                        nextRemainingTimeText = '発車済';
                                    }
                                    const nextTrainTypeClass = `train-type-${nextDeparture.trainName.replace(/\s+/g, '')}`;
                                    newItem.innerHTML = `
                                        <span class="time">${nextDeparture.time}</span>
                                        <span class="${nextTrainTypeClass}">${nextDeparture.trainName}</span>
                                        <span class="platform">${nextDeparture.platform}番線</span>
                                        <span class="trainName" style="display:none;">${nextDeparture.trainName}</span>
                                        <span class="destination">${nextDeparture.destination}</span>
                                        <span class="remarks">${nextRemainingTimeText}</span>
                                        <span>${nextDeparture.remarks}</span>
                                    `;
                                    departuresDiv.appendChild(newItem);
                                    displayedDepartures.push(nextDeparture);
                                }
                            }, 500);
                        }
                    }
                }
            }
        }

        function fetchDepartureData() {
            const apiUrl = 'https://kumoroha.github.io/trainboard/departures.json';

            fetch(apiUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("APIからのデータ:", data);
                    allDepartures = data.map(item => ({
                        time: item.time,
                        destination: item.destination,
                        platform: item.platform,
                        trainName: item.trainName,
                        remarks: item.remarks || '',
                    }));
                    displayDepartures();
                    setInterval(() => {
                        if (displayMode === 'realtime') {
                            displayDepartures();
                        } else if (displayMode === 'specifiedTime' && specified時刻) {
                            displayDepartures(specified時刻);
                        }
                    }, 60000);
                })
                .catch(error => {
                    console.error('APIからのデータ取得エラー:', error);
                    departuresDiv.textContent = '発車情報の取得に失敗しました。';
                });
        }

        realtimeRadio.addEventListener('change', () => {
            displayMode = 'realtime';
            specifiedTimeInput.disabled = true;
            displayDepartures();
        });

        specifiedTimeRadio.addEventListener('change', () => {
            displayMode = 'specifiedTime';
            specifiedTimeInput.disabled = false;
        });

        applyTimeButton.addEventListener('click', () => {
            if (displayMode === 'specifiedTime' && specifiedTimeInput.value) {
                specified時刻 = specifiedTimeInput.value;
                displayDepartures(specified時刻);
            }
        });

        fetchDepartureData();
    </script>
</body>
</html>
